<!doctype html>
<html>
	<head>
		<title>JS1k, 1k demo submission [ID]</title>
		<meta charset="utf-8" />
	</head>
	<body>
		<canvas id="c"></canvas>
		<script>
			var b = document.body;
			var c = document.getElementsByTagName('canvas')[0];
			var a = c.getContext('2d');
			document.body.clientWidth; // fix bug in webkit: http://qfox.nl/weblog/218
		</script>
		<script>
// start of submission //

b.style.margin = 0;
b.style.background = 'black';
c.style.display = 'block';
c.style.margin = '0 auto';
w = c.width = 800;
h = c.height = 600;

// create initial black background
a.font = 'bold 16px arial';
a.fillStyle = 'black';
a.fillRect(0, 0, w, h);

// create random pattern
randW = 180;
randH = 180;

randData = new Uint32Array(randW*randH);
for (i=0; i<=randW*randH-1; i++) {
    v = Math.floor(Math.random()*0xFFFFFFFF)|0xFF000000;
    randData[i] = v;
}

// read height map into typed array
scr = a.getImageData(0, 0, w, h);
scrData32 = new Uint32Array(scr.data.buffer);

PI = Math.PI;

render = function(t) {
    rt = randData[t%randData.length];
    u = Math.sin(t/10);

    for (y = 0; y < h; y+=2) {
        for (x = 0; x<randW; x++) {

            scrpos = y*w+x;

            randxpos = x%randW;
            randypos = y%randH;
            randpos = (randypos*randW + randxpos + rt)%randData.length;
            randv = randData[randpos];

            scrData32[scrpos]=randv;
        }

        for (x=randW; x<w; x++) {

            scrpos = y*w+x;

            rx = 3*PI*x/w;
            ry = 2*PI*y/h;
            fxy = (Math.sin(rx)*Math.cos(ry)*u+1)/2;
            scrv = Math.floor(fxy*40)

            scrrpos = (scrpos-randW+scrv);

            scrData32[scrpos] = scrData32[scrrpos];
        }

    }
    // write rendered frame back to canvas
    a.putImageData(scr, 0, 0);
    a.fillText('PHST/13', w-70, h-4);
}

var t = 0;
i = setInterval(function() {
    render(t++);
}, 55);

function stop() {
    window.clearInterval(i);
}

document.addEventListener('keydown', function(e) {
    [13,27,32].indexOf(e.keyCode) && stop();
});
document.addEventListener('click', function(e) {
    stop();
});



// end of submission //
		</script>
	</body>
</html>
