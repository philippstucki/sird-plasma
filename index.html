<!doctype html>
<html>
	<head>
		<title>JS1k, 1k demo submission [ID]</title>
		<meta charset="utf-8" />
	</head>
	<body>
		<canvas id="c"></canvas>
		<script>
			var b = document.body;
			var c = document.getElementsByTagName('canvas')[0];
			var a = c.getContext('2d');
			document.body.clientWidth; // fix bug in webkit: http://qfox.nl/weblog/218
		</script>
		<script>
// start of submission //





var PI, w,h,randW, randH, scr, scrData32, fps, t, st, shm=-1, run=1;

b.style.margin = 0;
b.style.background = 'black';
c.style.display = 'block';
c.style.margin = 'auto';
w = c.width = Math.min(innerWidth, 1000);
h = c.height = Math.min(((innerHeight/5)|0)*5, 600);

// create initial black background
a.font = 'bold 10px arial';
a.fillStyle = 'black';
a.fillRect(0, 0, w, h);
a.fillStyle = 'white';

// create random pattern
randW = randH = 150;

PI = Math.PI;

// create random data of randW * randH size
// color value satisfies 0 < v < 0xCF
randData = new Uint32Array(randW*randH);
for (i=0; i<=randW*randH-1; i++) {
    rv = Math.random()*0xCF|0;
    v = 0xFF300030 |(rv<<8);
    randData[i] = v;
}

// read height map into typed array
scr = a.getImageData(0, 0, w, h);
scrData32 = new Uint32Array(scr.data.buffer);

render = function(t, fps) {
    var rt, u, scrpos, randxpos, randypos, randv, scrv, scrrpos, rx, ry, fxy, xmod, ymod, ct, m;
    rt = randData[t%randData.length];
    u = Math.sin(t/30);

    for (y = 0; y < h; y+=5) {
        for (x = 0; x<randW; x++) {
            scrpos = y*w+x;
            randxpos = x%randW;
            randypos = y%randH;
            randpos = (randypos*randW + randxpos + rt)%randData.length;
            randv = randData[randpos];

            if (shm==1) {
                scrData32[scrpos]=0xFF000000;
            } else {
                scrData32[scrpos]=randv;
            }
        }

        for (x=randW; x<w; x++) {

            scrpos = y*w+x;

            m = 3;
            rx = m*PI*x/w;
            ry = m/2*PI*y/h;
            ct=t/30;

            fxy = Math.sin(rx+ct);
            fxy += Math.cos(ry+ct);
            fxy += Math.sin(3*(rx*Math.sin(ct/6)+ry*Math.cos(ct/4))+ct);

            fxy = (fxy+3)/6;
            fxy = fxy<0.4?0:fxy;

            scrv = (fxy*randW/3)|0;

            scrrpos = (scrpos-randW+scrv);
            if(shm==1) {
                scrData32[scrpos] = 0xFF000000|(scrv/randW*3*255);
            } else {
                scrData32[scrpos] = scrData32[scrrpos]; 
            }
        }

        l = scrData32.subarray(y*w, y*w+w);
        scrData32.set(l, (y+1)*w);
        scrData32.set(l, (y+2)*w);
        scrData32.set(l, (y+3)*w);

    }
    // write rendered frame back to canvas
    a.putImageData(scr, 0, 0);
    a.fillText('PHST/13 '+fps.toFixed(2)+' f/s', w-100, h-4);
}

t = fps = 0;
st = new Date().getTime();

i = setInterval(function() {
    if (run==1) {
        render(t++, fps);
        fps = Math.round(10*(t*1E3/(new Date().getTime() - st)))/10;
    }
}, 20);

function stop() {
    window.clearInterval(i);
}

document.addEventListener('keydown', function(e) {
    run = e.keyCode==32 ? run*-1 : run*1;
    shm = e.keyCode==72 ? shm*-1 : shm*1;
});




// end of submission //
		</script>
	</body>
</html>
